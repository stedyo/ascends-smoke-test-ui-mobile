{"version":3,"file":"withCompression.js","sourceRoot":"","sources":["../../src/addons/withCompression.ts"],"names":[],"mappings":";;;;;AACA,8CAA4D;AAC5D,kFAAiD;AACjD,4FAA2D;AAE3D,gCAAmC;AAEnC,oCAAoF;AAEpF;;GAEG;AACU,QAAA,oBAAoB,GAAG;IAClC,IAAI,EAAE,aAAa;IACnB,QAAQ,EAAE,kBAAkB;IAC5B,SAAS,EAAE,MAAM;IACjB,SAAS,EAAE,IAAI;IACf,QAAQ,EAAE,GAAG;CACd,CAAC;AAEF;;GAEG;AACU,QAAA,sBAAsB,GAAG;IACpC,KAAK,EAAE,kBAAkB;IACzB,IAAI,EAAE,aAAa;IACnB,SAAS,EAAE,IAAI;IACf,QAAQ,EAAE,GAAG;CACd,CAAC;AAEF;;;;;;GAMG;AACH,SAAwB,eAAe,CACrC,aAA+B,EAC/B,GAA8D;IAE9D,IAAI,aAAa,CAAC,IAAI,KAAK,YAAY,EAAE;QACvC,OAAO,aAAa,CAAC;KACtB;IAED,GAAG,CAAC,WAAW,GAAG,GAAG,CAAC,WAAW,IAAI,8BAAsB,EAAE,CAAC;IAE9D,MAAM,MAAM,GAAG,eAAS,CAAC,GAAG,CAAC,CAAC;IAC9B,OAAO,qBAAqB,CAAC,aAAa,EAAE,MAAM,CAAC,CAAC;AACtD,CAAC;AAZD,kCAYC;AAED;;;;;;GAMG;AACH,SAAgB,qBAAqB,CACnC,aAA+B,EAC/B,UAAsB;;IAEtB,MAAM,UAAU,GAAG,oCAA4B,aAC7C,UAAU,CAAC,GAAG,0CAAE,KAAK,0CAAE,IAAI,EAC3B,4BAAoB,EACpB,IAAI,CACL,CAAC;IACF,MAAM,YAAY,GAAG,kCAA0B,aAC7C,UAAU,CAAC,GAAG,0CAAE,KAAK,0CAAE,MAAM,EAC7B,8BAAsB,EACtB,IAAI,CACL,CAAC;IAEF,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,aAAa,CAAC,OAAO,CAAC;QAAE,aAAa,CAAC,OAAO,GAAG,EAAE,CAAC;IAEtE,IAAI,UAAU;QAAE,aAAa,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,oCAAiB,CAAC,UAAU,CAAC,CAAC,CAAC;IAC9E,IAAI,YAAY;QAAE,aAAa,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,+BAAY,CAAC,YAAY,CAAC,CAAC,CAAC;IAE7E,OAAO,aAAa,CAAC;AACvB,CAAC;AArBD,sDAqBC","sourcesContent":["import { ExpoConfig } from '@expo/config';\nimport { getPossibleProjectRoot } from '@expo/config/paths';\nimport BrotliPlugin from 'brotli-webpack-plugin';\nimport CompressionPlugin from 'compression-webpack-plugin';\n\nimport { getConfig } from '../env';\nimport { AnyConfiguration, Environment } from '../types';\nimport { enableWithPropertyOrConfig, overrideWithPropertyOrConfig } from '../utils';\n\n/**\n * @internal\n */\nexport const DEFAULT_GZIP_OPTIONS = {\n  test: /\\.(js|css)$/,\n  filename: '[path].gz[query]',\n  algorithm: 'gzip',\n  threshold: 1024,\n  minRatio: 0.8,\n};\n\n/**\n * @internal\n */\nexport const DEFAULT_BROTLI_OPTIONS = {\n  asset: '[path].br[query]',\n  test: /\\.(js|css)$/,\n  threshold: 1024,\n  minRatio: 0.8,\n};\n\n/**\n * Add production compression options to the provided Webpack config.\n *\n * @param webpackConfig Existing Webpack config to modify.\n * @param env Environment used for getting the Expo project config.\n * @category addons\n */\nexport default function withCompression(\n  webpackConfig: AnyConfiguration,\n  env: Pick<Environment, 'projectRoot' | 'config' | 'locations'>\n): AnyConfiguration {\n  if (webpackConfig.mode !== 'production') {\n    return webpackConfig;\n  }\n\n  env.projectRoot = env.projectRoot || getPossibleProjectRoot();\n\n  const config = getConfig(env);\n  return addCompressionPlugins(webpackConfig, config);\n}\n\n/**\n * Add Gzip and Brotli compression plugins to the provided Webpack config.\n *\n * @param webpackConfig Existing Webpack config to modify.\n * @param expoConfig Expo config with compression options.\n * @internal\n */\nexport function addCompressionPlugins(\n  webpackConfig: AnyConfiguration,\n  expoConfig: ExpoConfig\n): AnyConfiguration {\n  const gzipConfig = overrideWithPropertyOrConfig(\n    expoConfig.web?.build?.gzip,\n    DEFAULT_GZIP_OPTIONS,\n    true\n  );\n  const brotliConfig = enableWithPropertyOrConfig(\n    expoConfig.web?.build?.brotli,\n    DEFAULT_BROTLI_OPTIONS,\n    true\n  );\n\n  if (!Array.isArray(webpackConfig.plugins)) webpackConfig.plugins = [];\n\n  if (gzipConfig) webpackConfig.plugins.push(new CompressionPlugin(gzipConfig));\n  if (brotliConfig) webpackConfig.plugins.push(new BrotliPlugin(brotliConfig));\n\n  return webpackConfig;\n}\n"]}